[[_06_mail]]
== Configuration de l'envoi de mails

:ovh:  pass:[<span style="color: #46caf6">OVH</span>]
:gmail:  pass:[<span style="color: #185abc">gmail</span>]
:gworkspace:  pass:[<span style="color: #185abc">Google Workspace</span>]
:o365:  pass:[<span style="color: #a84d58">Office 365</span>]

[NOTE]
====
Ce paramétrage permet aux utilisateurs d'{arcadeged} d'envoyer des mails à d'autres utilisateurs ou à des personnes externes.

Il permet également l'envoi de notifications (_si paramétrées_) dans l'application.
====

Le paramétrage se fait via l'{adminAirs} ou directement dans le fichier {paramsXml}.

[source,xml]
----
<mailConfig>
  <protocol>smtps</protocol>
  <smtp>ssl0.ovh.net</smtp>
  <defaultMailSender>dossier@___.fr</defaultMailSender>
  <defaultMailSenderPwd>ENC(XXX)</defaultMailSenderPwd>
  <SSLActivated>false</SSLActivated>
  <TLSActivated>true</TLSActivated>
  <smtpPort>465</smtpPort>
  <mailAuthentication>false</mailAuthentication>
</mailConfig>
----

[cols="2a,4a,1a",options="header"]
|===
|Attribut|Description|Obligatoire?
|*protocol*|Protocole: *smtp* (défaut) ou *smtps*|[green]#Oui#
|*smtp*|Host/adresse du serveur d'envoi de mails|[green]#Oui#
|*smtpPort*|Port du serveur d'envoi de mails|[green]#Oui#
|*defaultMailSender*|Si le serveur *smtp* nécessite une authentification, renseigner ici l'émetteur par défaut à utiliser|
|*defaultMailSenderPwd*|Si le serveur *smtp* nécessite une authentification, renseigner ici le mot de passe de l'émetteur défini dans la balise *defaultMailSender*|
|*SSLActivated*|Activation du mode *SSL* (*true* / *false*)|
|*TLSActivated*|Activation du mode *TLS* (*true* / *false*)|
|*mailAuthentication*|L'envoi de mail nécessite une authentification. Si activé, la demande de mot de passe (mail) de l'utilisateur sera disponible dans la
fenêtre d'envoi de mail.|
|===

=== Paramètres additionnels

Si certains paramètres ne sont pas pris en compte dans cette structure, vous pouvez les ajouter via le fichier *WEB-INF/classes/mail/mail-additional
.properties*.

Par exemple
[source,properties]
----
mail.smtp.ssl.trust=smtp.gmail.com
----

=== Certificats

Si vous avez un souci d'envoi de mail relatif à un certificat (erreur *pkix*, ...), veuillez intégrer le certificat dans le magasin de la {jdk}.

[TIP]
====
Si l'envoi concerne un compte {gmail}, l'ajout de la propriété *mail.smtp.ssl.trust=smtp.gmail.com* peut résoudre également le problème (cf. chapitre
précédent).
====

=== Examples

==== {ovh}

[source,xml]
----
<mailConfig>
  <protocol>smtps</protocol>
  <smtp>ssl0.ovh.net</smtp>
  <SSLActivated>false</SSLActivated>
  <TLSActivated>true</TLSActivated>
  <smtpPort>465</smtpPort>
</mailConfig>
----

==== {gmail}

[source,xml]
----
<mailConfig>
  <protocol>smtps</protocol>
  <smtp>smtp.gmail.com</smtp>
  <SSLActivated>false</SSLActivated>
  <TLSActivated>true</TLSActivated>
  <smtpPort>587</smtpPort>
</mailConfig>
----

Si un compte est défini (_defaultMailSender_ et _defaultMailSenderPwd_), *attention*, le mot de passe attaché au compte n'est pas celui utilisé lors de
l'authentification à l'interface {gmail}.

Il faut alors :

* activer la *double authentification*
* générer un mot de passe [underline]#dédié# via la https://myaccount.google.com/apppasswords[page suivante]

[source,xml]
----
<mailConfig>
  <protocol>smtps</protocol>
  <smtp>smtp.gmail.com</smtp>
  <SSLActivated>true</SSLActivated>
  <TLSActivated>false</TLSActivated>
  <smtpPort>465</smtpPort>
</mailConfig>
----

==== {o365}

Attention, cela ne fonctionne que si *SMTP* est activé sur le compte *Microsoft* associé (cf. procédure https://learn.microsoft.com/en-us/exchange/clients-and-mobile-in-exchange-online/authenticated-client-smtp-submission#use-the-microsoft-365-admin-center-to-enable-or-disable-smtp-auth-on-specific-mailboxes[ici])

[source,xml]
----
<mailConfig>
  <protocol>smtp</protocol>
  <smtp>smtp.office365.com</smtp>
  <SSLActivated>false</SSLActivated>
  <TLSActivated>true</TLSActivated>
  <smtpPort>587</smtpPort>
</mailConfig>
----

[IMPORTANT]
====
À partir de septembre 2025, *Microsoft* a désactivé cette fonctionnalité. +
Une authentification via *OAuth* est alors obligatoire.
====

=== Authentification moderne OAuth

Pour activer ce mode d'authentification, il faut ajouter la balise *oauth* à l'intérieur de la balise *mailConfig*.

Si cette configuration est activée, le mot de passe de la balise *defaultMailSenderPwd* sera ignoré.

Dans la version actuelle, l'application implémente l'authentification moderne pour {o365} et {gworkspace}.

==== {o365}

===== Configuration Microsoft Office 365 / Azure AD

Pour ce mode de fonctionnement, une *application d’entreprise* doit être créée (ou exister) dans *Microsoft Azure Active Directory*. Elle devra posséder les
autorisations d'API suivantes :

.Microsoft Graph
[%autowidth,cols="<s,<,<"]
|===
|email |Déléguée |Afficher l'adresse e-mail des utilisateurs
|Mail.ReadWrite |Application |Read and write mail in all mailboxes
|Mail.Send |Application |Send mail as any user
|offline_access |Déléguée |Conserver l'accès aux données auxquelles vous lui avez donné accès
|openid |Déléguée |Connecter les utilisateurs
|profile |Déléguée |Afficher le profil de base des utilisateurs
|===

.Office 365 Exchange Online
[%autowidth,cols="<s,<,<"]
|===
|full_access_as_app |Application |Use Exchange WEB Services with full access to all mailboxes
|Mail.ReadWrite |Application |Read and write mail in all mailboxes
|Mail.Send |Application |Send mail as any user
|SMTP.SendAsApp |Application |Application access for sending emails via SMTP AUTH
|===

Il faut ensuite récupérer ces 2 informations depuis la *Vue d'ensemble* :

* tenantId : ID de l'annuaire
* clientId : ID d'application

image::./06_mail/application_infos.png[]

Enfin, depuis le menu *Certificats et secrets*, créez un secret client dont vous récupèrerez la *valeur* (à ne pas confondre avec l'ID du secret).

image::./06_mail/add_secret.png[]

Attention au bout d'un certain temps après sa création, il n'est plus possible de copier la *valeur* du secret, il faut donc bien la récupérer la 1ère fois et la conserver.

image::./06_mail/copy_secret.png[]

Pour envoyer des mails via Microsoft Exchange Online / Office 365 avec une application (sans mot de passe utilisateur), il faut créer/configurer un service
principal dans Azure AD et lui attribuer les permissions nécessaires. Le service principal peut être créé à l’aide des commandes PowerShell ci-dessous (s’il n’existe pas déjà) :

[source, cmd]
----
Connect-AzureAD
----

→ S’authentifier dans la fenêtre qui s’ouvre.

Récupération des identifiants de l’application d’entreprise (Dossier est le nom de l’application
dans Microsoft Azure AD) :

[source, cmd]
----
Get-AzureADServicePrincipal -SearchString Dossier
----

Résultat :

[source, cmd]
----
ObjectId AppId DisplayName
-------- ----- -----------
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB Courrier
----

« CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC » ce sera le tenantId (ou id du locataire) évoqué précédemment.

Avec ces 3 informations, on peut procéder à l’enregistrement du service principal :

[source, cmd]
----
Connect-ExchangeOnline
----

→ S’authentifier dans la fenêtre qui s’ouvre.

[source, cmd]
----
New-ServicePrincipal -AppId BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB -ServiceId
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA -Organization
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
----

[source, cmd]
----
Get-ServicePrincipal -Organization AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA | fl
Add-MailboxPermission -Identity "prenom.nom@xxxxx.onmicrosoft.com" -User AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA -AccessRights FullAccess
----

Le service principal est maintenant créé et possède les droits d'accès à la boîte mail de l'utilisateur.

===== Configuration {arcadeged}

Configuration de la balise *oauth* :

[source,xml,subs="normal,quotes"]
----
<oauth impl="MSOfficeOAuthAccess" url="https://login.microsoftonline.com/%s/oauth2/v2.0/token"
       scope="https://outlook.office.com/.default" tenantId="tenantId" clientId="clientId" secret="secret"/>
----

==== {gworkspace}

Pour permettre à l’application d’aspirer les emails via un compte de service Google, il est nécessaire de configurer à la fois Google Cloud et la console d’administration Google Workspace.

Prérequis :

* Un projet Google Cloud existe déjà (ou devra être créé), et vous y avez les droits d’administration.
* L’API Gmail est activée (Console Google Cloud → API et services → Bibliothèque).
* Le compte Google Workspace dispose des droits pour la délégation au niveau du domaine.

===== Configuration dans Google Cloud Console

Rendez vous sur la console https://console.cloud.google.com/welcome[Google Cloud] et allez dans votre projet.

* Écran de consentement OAuth

1) À partir du menu latéral, naviguez vers *API et services* → Écran de consentement OAuth.

image::./06_mail/api_services.png[]

2) Vérifiez via le menu *Audience* que le type d’utilisateur est *Interne* (usage au sein de l’organisation) ou *Externe* (accès public).

image::./06_mail/audience.png[]

3) Naviguez ensuite dans *Accès aux données*, cliquez sur *Ajouter ou supprimer des niveaux d'accès*, puis ajoutez *https://mail.google.com/*

image::./06_mail/data_access.png[]

* Comptes de service

1) Rendez-vous dans IAM et administration → Comptes de service.

image::./06_mail/service_accounts.png[]

2) Si besoin, créez un compte de service.

3) Pour ce compte, générez une clé privée au format JSON (Actions → Gérer les clés → Ajouter une clé → JSON) et conservez le fichier. Ce fichier JSON de
configuration doit être mentionné dans l'attribut *confFile* de la balise *oauth*.

4) Relevez l’ID client du compte de service pour l’étape suivante.

image::./06_mail/account_id.png[]

===== Configuration dans la console d’administration Google Workspace

* Délégation au niveau du domaine

1) Connectez-vous à admin.google.com.

2) Allez dans Sécurité → Contrôles d’accès et des données → Commandes des API.

3) Ouvrez Délégation au niveau du domaine.

4) Si l’ID client du compte de service n’apparaît pas, cliquez sur Ajouter un client API.

5) Saisissez l’ID client récupéré précédemment.

6) Dans Champs d’application OAuth (virgule‐séparés), entrez : https://mail.google.com/

7) Cliquez sur Autoriser.

Une fois ces étapes accomplies, l’application pourra utiliser le compte de service pour aspirer les emails des utilisateurs du domaine Google Workspace, sans nécessiter leurs mots de passe individuels.

===== Configuration {arcadeged}

Configuration de la balise *oauth* :

[source,xml,subs="normal,quotes"]
----
<oauth impl="GoogleGMailOAuthAccess" scope="https://mail.google.com/" confFile="digi-office-gsuite-1a1111111111 1.json"/>
----

==== Exemples de configuration avec la balise oauth

===== {o365}

[source,xml]
----
<mailConfig>
    <smtp>smtp.office365.com</smtp>
    <defaultMailSender>prenom.nom@xxxxx.onmicrosoft.com</defaultMailSender>
    <SSLActivated>false</SSLActivated>
    <TLSActivated>true</TLSActivated>
    <SSLPort>-1</SSLPort>
    <smtpPort>587</smtpPort>
    <mailAuthentication>true</mailAuthentication>
    <protocol>smtp</protocol>
    <oauth impl="MSOfficeOAuthAccess" scope="https://outlook.office.com/.default" url="https://login.microsoftonline.com/%s/oauth2/v2.0/token"
           tenantId="tenantId" clientId="clientId" secret="secret"/>
</mailConfig>
----

===== {gworkspace}

[source,xml]
----
<mailConfig>
    <smtp>smtp.gmail.com</smtp>
    <defaultMailSender>prenom.nom@gmail.com</defaultMailSender>
    <SSLActivated>false</SSLActivated>
    <TLSActivated>true</TLSActivated>
    <SSLPort>-1</SSLPort>
    <smtpPort>587</smtpPort>
    <mailAuthentication>true</mailAuthentication>
    <protocol>smtp</protocol>
    <oauth impl="GoogleGMailOAuthAccess" scope="https://mail.google.com/" confFile="confFile.json"/>
</mailConfig>
----