[[_17_FieldDependency]]
== {FieldDependency}

=== Description

Ce script est déclenché lorsque l'on souhaite avoir une *dépendance* entre les valeurs de certains champs.

Les exemples les plus courants sont :

* La mise à jour d'une liste de valeurs lorsqu'un utilisateur a précédemment sélectionné un élément dans une autre liste/champ.
* Le calcul de la valeur d'un champ lorsqu'une donnée est saisie dans un ou plusieurs autres champs (tel le calcul automatique d'une durée ou de l'âge d'une
personne)

=== Paramètres

cf. <<_01_CommonData,attributs communs>>.

[options="noheader",cols="2a,2a,3a"]
|===
|[.sub-header]
_Nom_|[.sub-header]
_Type_|[.sub-header]
_Description_
3+|[.header]
Entrées
|*_fieldToUpdate*|IField|Champ à mettre à jour
|*_fieldMap*|Map<String, IField>|Liste des champs
|*_updatedField*|IField|Champ que l'on modifie
|*_updateFieldValues*|Object|List des SelectItem en entrée/sortie
|*_parameterMap*|List<IParameter>|
|*_mode*|*com.digitech.dossier.script.model.impl.result.ScriptModeRun*|Contexte d'exécution du script (page en cours), parmi les valeurs :

* *CREATE*: création d'un document
* *UPDATE*: mise à jour d'un document
* *SEARCH*: écran de saisie de critères de recherche
3+|[.header]
Entrées/sorties
|*_result*|*com.digitech.dossier.script.model.impl.result.IScriptResultModel<T>*|
|===

=== Exemple

Modification de la liste des choix pour le champ _Plan de classement_ lorsque la valeur du champ _Catégorie de document_ est modifiée.

[source, groovy]
----
import com.digitech.dossier.common.utils.JSFUtils

List<SelectItem> selectItems = new SelectItemFactory().getAuthorities(_fieldToUpdate.getConfigField())
Term updatedFieldCode = getAuthorityListService().getTerm((Integer) _updatedField.getValue())

List<SelectItem> test = new ArrayList<>()
for(items in selectItems) {
  if(items.getValue() != null) {
    Term code = getAuthorityListService().getTerm((Integer) items.getValue())
    SelectItem item = new SelectItem()
    item.setLabel(code.getValues()[0] as String)
    item.setValue(code.getCode())
    test.add(item)
  }
}
List<SelectItem> filteredItems = test.findAll({it.getValue().startsWith(updatedFieldCode.getCode() as String)})

if(binding.variables.containsKey("_updateFieldValues")) { // cas search/suggestion list
  _updateFieldValues.clear()
  _updateFieldValues.addAll(filteredItems)
}
else if(binding.variables.containsKey("_fieldToUpdate")) { // cas list component
  JSFUtils.setSelectOneMenuListValues(_fieldToUpdate?.getComponent(), filteredItems)
}
else {
  _scriptLogger.warn("neither '_fieldToUpdate' nor '_updateFieldValues' variable is available?!?")
}

/**
 * @return IAuthorityList the Authority List
 */
public static IAuthorityList getAuthorityListService() {
  return (IAuthorityList) ServiceManager.getInstance().getService(com.digitech.dossier.common.service.Constants.SERVICE_AIRS_AUTHORITYLIST_MGR)
}
----

.Exemple de choix pour la catégorie Commerce
image:examples/field_dependency_example_commerce.png[]

.Exemple de choix pour la catégorie Comptabilité
image:examples/field_dependency_example_compta.png[]